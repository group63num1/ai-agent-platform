# 验证码发送问题排查指南

## 问题1：邮箱验证码发送失败

### 可能的原因和解决方案

#### 1. 邮箱配置问题

**检查项：**
- 确认 `application.yml` 中的邮箱配置正确
- 确认邮箱地址和授权码正确
- 确认SMTP服务器地址和端口正确

**QQ邮箱配置示例：**
```yaml
spring:
  mail:
    host: smtp.qq.com
    port: 587
    username: your-email@qq.com  # 你的QQ邮箱
    password: your-authorization-code  # QQ邮箱授权码（不是登录密码）
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true
```

**如何获取QQ邮箱授权码：**
1. 登录QQ邮箱
2. 点击"设置" -> "账户"
3. 找到"POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务"
4. 开启"POP3/SMTP服务"或"IMAP/SMTP服务"
5. 点击"生成授权码"，按照提示获取授权码
6. 将授权码填入 `application.yml` 的 `password` 字段

#### 2. 网络连接问题

**检查项：**
- 确认服务器可以访问SMTP服务器（smtp.qq.com）
- 检查防火墙是否阻止了587端口
- 确认网络连接正常

**测试方法：**
```bash
# 测试SMTP服务器连接
telnet smtp.qq.com 587
```

#### 3. 邮箱服务商限制

**可能的问题：**
- 发送频率过高被限制
- 邮箱账户被临时封禁
- 需要验证身份

**解决方案：**
- 降低发送频率
- 检查邮箱是否有异常登录提醒
- 联系邮箱服务商解除限制

#### 4. 查看详细错误信息

**查看后端控制台输出：**
- 启动应用后，查看控制台输出的详细错误信息
- 错误信息会包含具体的失败原因

**常见错误：**
- `535 Error: authentication failed` - 授权码错误
- `Connection timed out` - 网络连接问题
- `Could not connect to SMTP host` - SMTP服务器地址或端口错误

## 问题2：手机验证码显示发送成功但接收不到

### 原因说明

**当前实现：**
- 系统目前处于**开发模式**，短信验证码并未真正发送
- 验证码会打印到后端控制台，方便开发测试

### 查看验证码的方法

**方法1：查看后端控制台**
1. 启动后端应用
2. 发送手机验证码
3. 在后端控制台查看输出，格式如下：

```
========================================
【开发模式】短信验证码（仅用于测试）
手机号: 13800138000
验证码: 123456
短信内容: 欢迎注册用户管理系统！您的注册验证码是: 123456，有效期为 5 分钟。
有效期: 5 分钟
========================================
⚠️ 注意：这是开发模式，短信并未真正发送！
⚠️ 实际生产环境需要集成短信服务商（如阿里云、腾讯云等）
========================================
```

**方法2：查看数据库**
- 验证码会保存到 `user_verification_codes` 表
- 可以查询数据库获取验证码

### 生产环境集成短信服务

**需要集成短信服务商：**
- 阿里云短信服务
- 腾讯云短信服务
- 其他短信服务商

**集成步骤（以阿里云为例）：**
1. 注册阿里云账号
2. 开通短信服务
3. 创建短信模板
4. 获取AccessKey和Secret
5. 在代码中集成SDK

**示例代码：**
```java
// 在 VerificationCodeServiceImpl 中集成
// 1. 添加依赖（pom.xml）
// <dependency>
//     <groupId>com.aliyun</groupId>
//     <artifactId>dysmsapi20170525</artifactId>
//     <version>2.0.0</version>
// </dependency>

// 2. 实现短信发送
public boolean sendSmsCode(String phone, String type, Long userId) {
    try {
        String code = generateVerificationCode(phone, type, userId);
        
        // 使用阿里云SDK发送短信
        Config config = new Config()
            .setAccessKeyId("your-access-key-id")
            .setAccessKeySecret("your-access-key-secret");
        config.endpoint = "dysmsapi.aliyuncs.com";
        
        Client client = new Client(config);
        SendSmsRequest request = new SendSmsRequest()
            .setPhoneNumbers(phone)
            .setSignName("你的签名")
            .setTemplateCode("你的模板代码")
            .setTemplateParam("{\"code\":\"" + code + "\"}");
        
        SendSmsResponse response = client.sendSms(request);
        return response.getBody().getCode().equals("OK");
    } catch (Exception e) {
        e.printStackTrace();
        return false;
    }
}
```

## 调试技巧

### 1. 开启邮件调试模式

在 `EmailConfig.java` 中已经开启了调试模式：
```java
props.put("mail.debug", "true");
```

这会输出详细的SMTP通信日志。

### 2. 查看日志

**查看应用日志：**
- 检查控制台输出的错误信息
- 查看日志文件（如果配置了日志文件）

**日志级别：**
```yaml
logging:
  level:
    com.example.demo: debug
```

### 3. 测试邮箱配置

**使用Spring Boot测试：**
```java
@SpringBootTest
public class EmailTest {
    @Autowired
    private JavaMailSender mailSender;
    
    @Test
    public void testSendEmail() {
        SimpleMailMessage message = new SimpleMailMessage();
        message.setFrom("your-email@qq.com");
        message.setTo("test@example.com");
        message.setSubject("测试邮件");
        message.setText("这是一封测试邮件");
        mailSender.send(message);
    }
}
```

## 常见问题FAQ

### Q1: 为什么邮箱验证码发送失败？
**A:** 最常见的原因是授权码错误或邮箱配置不正确。请检查：
1. 授权码是否正确（不是登录密码）
2. SMTP服务器地址和端口是否正确
3. 是否开启了SMTP服务

### Q2: 手机验证码在哪里查看？
**A:** 开发模式下，验证码会打印到后端控制台。生产环境需要集成短信服务商。

### Q3: 如何切换到生产环境？
**A:** 需要：
1. 集成短信服务商SDK
2. 配置短信服务商的密钥和模板
3. 修改 `sendSmsCode` 方法，使用真实的短信服务

### Q4: 验证码有效期是多久？
**A:** 默认5分钟，可以在 `application.yml` 中配置：
```yaml
verification:
  code:
    expire:
      minutes: 5
```

### Q5: 发送频率限制是多少？
**A:** 默认1分钟内最多发送3次，可以在 `application.yml` 中配置：
```yaml
verification:
  rate:
    limit:
      minutes: 1
```

## 联系支持

如果以上方法都无法解决问题，请：
1. 查看后端控制台的完整错误信息
2. 检查网络连接和防火墙设置
3. 确认邮箱/短信服务商的配置正确
4. 联系技术支持获取帮助

