<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.app.mapper.RoleMapper">

    <resultMap id="RoleResultMap" type="com.example.demo.app.entity.Role">
        <id column="id" property="id" />
        <result column="name" property="name" />
        <result column="code" property="code" />
        <result column="description" property="description" />
        <result column="is_system" property="isSystem" />
        <result column="status" property="status" />
        <result column="sort_order" property="sortOrder" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
        <result column="deleted_at" property="deletedAt" />
    </resultMap>

    <sql id="Role_Column_List">
        id, name, code, description, is_system, status, sort_order,
        created_at, updated_at, deleted_at
    </sql>

    <insert id="insert" parameterType="com.example.demo.app.entity.Role"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO roles (
            name, code, description, is_system, status, sort_order,
            created_at, updated_at
        ) VALUES (
                     #{name}, #{code}, #{description}, #{isSystem}, #{status}, #{sortOrder},
                     NOW(), NOW()
                 )
    </insert>

    <select id="selectById" resultMap="RoleResultMap">
        SELECT <include refid="Role_Column_List" />
        FROM roles
        WHERE id = #{id} AND deleted_at IS NULL
    </select>

    <select id="selectByCode" resultMap="RoleResultMap">
        SELECT <include refid="Role_Column_List" />
        FROM roles
        WHERE code = #{code} AND deleted_at IS NULL
    </select>

    <select id="selectAll" resultMap="RoleResultMap">
        SELECT <include refid="Role_Column_List" />
        FROM roles
        WHERE deleted_at IS NULL
        ORDER BY sort_order ASC
    </select>

    <!-- 添加这个缺失的方法 -->
    <select id="selectByUserId" resultMap="RoleResultMap">
        SELECT r.id, r.name, r.code, r.description, r.is_system, r.status,
               r.sort_order, r.created_at, r.updated_at, r.deleted_at
        FROM roles r
                 INNER JOIN user_roles ur ON r.id = ur.role_id
        WHERE ur.user_id = #{userId}
          AND r.deleted_at IS NULL
          AND (ur.expires_at IS NULL OR ur.expires_at > NOW())
        ORDER BY r.sort_order ASC
    </select>

    <select id="selectByStatus" resultMap="RoleResultMap">
        SELECT <include refid="Role_Column_List" />
        FROM roles
        WHERE status = #{status} AND deleted_at IS NULL
        ORDER BY sort_order ASC
    </select>

    <select id="selectSystemRoles" resultMap="RoleResultMap">
        SELECT <include refid="Role_Column_List" />
        FROM roles
        WHERE is_system = 1 AND deleted_at IS NULL
        ORDER BY sort_order ASC
    </select>

    <update id="update" parameterType="com.example.demo.app.entity.Role">
        UPDATE roles
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="code != null">code = #{code},</if>
            <if test="description != null">description = #{description},</if>
            <if test="isSystem != null">is_system = #{isSystem},</if>
            <if test="status != null">status = #{status},</if>
            <if test="sortOrder != null">sort_order = #{sortOrder},</if>
            updated_at = NOW()
        </set>
        WHERE id = #{id} AND deleted_at IS NULL
    </update>

    <update id="softDelete">
        UPDATE roles
        SET deleted_at = NOW(), updated_at = NOW()
        WHERE id = #{id} AND deleted_at IS NULL AND is_system = 0
    </update>

</mapper>