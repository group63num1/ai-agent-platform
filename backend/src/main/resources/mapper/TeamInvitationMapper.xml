<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.app.mapper.TeamInvitationMapper">

    <resultMap id="TeamInvitationResultMap" type="com.example.demo.app.entity.TeamInvitation">
        <id column="id" property="id" />
        <result column="team_id" property="teamId" />
        <result column="inviter_id" property="inviterId" />
        <result column="invitee_email" property="inviteeEmail" />
        <result column="invitee_user_id" property="inviteeUserId" />
        <result column="invitation_code" property="invitationCode" />
        <result column="role" property="role" />
        <result column="message" property="message" />
        <result column="status" property="status" />
        <result column="expires_at" property="expiresAt" />
        <result column="responded_at" property="respondedAt" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
    </resultMap>

    <sql id="TeamInvitation_Column_List">
        id, team_id, inviter_id, invitee_email, invitee_user_id, invitation_code,
        role, message, status, expires_at, responded_at, created_at, updated_at
    </sql>

    <insert id="insert" parameterType="com.example.demo.app.entity.TeamInvitation"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO team_invitations (
            team_id, inviter_id, invitee_email, invitee_user_id, invitation_code,
            role, message, status, expires_at, created_at, updated_at
        ) VALUES (
                     #{teamId}, #{inviterId}, #{inviteeEmail}, #{inviteeUserId}, #{invitationCode},
                     #{role}, #{message}, #{status}, #{expiresAt}, NOW(), NOW()
                 )
    </insert>

    <select id="selectById" resultMap="TeamInvitationResultMap">
        SELECT <include refid="TeamInvitation_Column_List" />
        FROM team_invitations
        WHERE id = #{id}
    </select>

    <select id="selectByInvitationCode" resultMap="TeamInvitationResultMap">
        SELECT <include refid="TeamInvitation_Column_List" />
        FROM team_invitations
        WHERE invitation_code = #{invitationCode}
    </select>

    <select id="selectByTeamId" resultMap="TeamInvitationResultMap">
        SELECT <include refid="TeamInvitation_Column_List" />
        FROM team_invitations
        WHERE team_id = #{teamId}
        ORDER BY created_at DESC
    </select>

    <select id="selectByInviterId" resultMap="TeamInvitationResultMap">
        SELECT <include refid="TeamInvitation_Column_List" />
        FROM team_invitations
        WHERE inviter_id = #{inviterId}
        ORDER BY created_at DESC
    </select>

    <select id="selectByInviteeEmail" resultMap="TeamInvitationResultMap">
        SELECT <include refid="TeamInvitation_Column_List" />
        FROM team_invitations
        WHERE invitee_email = #{inviteeEmail}
        ORDER BY created_at DESC
    </select>

    <select id="selectByInviteeUserId" resultMap="TeamInvitationResultMap">
        SELECT <include refid="TeamInvitation_Column_List" />
        FROM team_invitations
        WHERE invitee_user_id = #{inviteeUserId}
        ORDER BY created_at DESC
    </select>

    <select id="selectPendingInvitations" resultMap="TeamInvitationResultMap">
        SELECT <include refid="TeamInvitation_Column_List" />
        FROM team_invitations
        WHERE status = 'pending'
        AND expires_at > NOW()
        AND (
        (invitee_email = #{inviteeEmail} AND invitee_email IS NOT NULL)
        OR (invitee_user_id = #{inviteeUserId} AND invitee_user_id IS NOT NULL)
        )
        ORDER BY created_at DESC
    </select>

    <update id="updateStatus">
        UPDATE team_invitations
        SET status = #{status},
            responded_at = #{respondedAt},
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <update id="expireOldInvitations">
        UPDATE team_invitations
        SET status = 'expired',
            updated_at = NOW()
        WHERE status = 'pending'
          AND expires_at &lt;= #{currentTime}
    </update>

    <delete id="deleteByTeamId">
        DELETE FROM team_invitations
        WHERE team_id = #{teamId}
    </delete>

</mapper>