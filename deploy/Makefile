#=========================Makefile for Health Agent Platform ====================
# ç®€åŒ–çš„å®¹å™¨åŒ–éƒ¨ç½²å‘½ä»¤æ¥å£

.PHONY: help deploy build build-backend build-frontend start stop restart logs logs-backend logs-frontend logs-mysql ps clean status backup

.DEFAULT_GOAL := help

# ==================== å¸®åŠ©ä¿¡æ¯ ====================
help:
	@echo "========================================"
	@echo "å¿ƒç†å¥åº· Agent å¹³å° - éƒ¨ç½²å‘½ä»¤"
	@echo "========================================"
	@echo ""
	@echo "éƒ¨ç½²å‘½ä»¤ï¼š"
	@echo "  make deploy         - í ½íº€ ä¸€é”®éƒ¨ç½²ï¼ˆæ„å»º+å¯åŠ¨ï¼‰"
	@echo "  make build          - í ½í³¦ æ„å»ºæ‰€æœ‰é•œåƒ"
	@echo "  make build-backend  - í ½í³¦ åªæ„å»ºåç«¯"
	@echo "  make build-frontend - í ½í³¦ åªæ„å»ºå‰ç«¯"
	@echo ""
	@echo "æœåŠ¡æ§åˆ¶ï¼š"
	@echo "  make start          - â–¶ï¸  å¯åŠ¨æ‰€æœ‰æœåŠ¡"
	@echo "  make stop           - â¹ï¸  åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo "  make restart        - í ½í´„ é‡å¯æ‰€æœ‰æœåŠ¡"
	@echo "  make ps             - í ½í³‹ æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo ""
	@echo "æ—¥å¿—æŸ¥çœ‹ï¼š"
	@echo "  make logs           - í ½í³œ æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—"
	@echo "  make logs-backend   - í ½í³œ æŸ¥çœ‹åç«¯æ—¥å¿—"
	@echo "  make logs-frontend  - í ½í³œ æŸ¥çœ‹å‰ç«¯æ—¥å¿—"
	@echo "  make logs-mysql     - í ½í³œ æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—"
	@echo ""
	@echo "è¿ç»´ç®¡ç†ï¼š"
	@echo "  make status         - âœ… æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€"
	@echo "  make backup         - í ½í²¾ å¤‡ä»½æ•°æ®åº“"
	@echo "  make clean          - í ½í·‘ï¸  æ¸…ç†æ‰€æœ‰å®¹å™¨å’Œé•œåƒ"
	@echo ""

# ==================== éƒ¨ç½²å‘½ä»¤ ====================
deploy:
	@echo "í ½íº€ å¼€å§‹ä¸€é”®éƒ¨ç½²..."
	@./deploy.sh

# ==================== æ„å»ºå‘½ä»¤ ====================
build:
	@echo "í ½í³¦ æ„å»ºæ‰€æœ‰æœåŠ¡é•œåƒ..."
	@docker-compose build

build-backend:
	@echo "í ½í³¦ æ„å»ºåç«¯é•œåƒ..."
	@docker-compose build backend

build-frontend:
	@echo "í ½í³¦ æ„å»ºå‰ç«¯é•œåƒ..."
	@docker-compose build web-admin h5-mobile

# ==================== æœåŠ¡æ§åˆ¶ ====================
start:
	@echo "â–¶ï¸  å¯åŠ¨æ‰€æœ‰æœåŠ¡..."
	@docker-compose up -d
	@echo "âœ… æœåŠ¡å·²å¯åŠ¨ï¼"
	@docker-compose ps

stop:
	@echo "â¹ï¸  åœæ­¢æ‰€æœ‰æœåŠ¡..."
	@docker-compose down
	@echo "âœ… æœåŠ¡å·²åœæ­¢ï¼"

restart: stop
	@sleep 2
	@$(MAKE) start

ps:
	@docker-compose ps

# ==================== æ—¥å¿—æŸ¥çœ‹ ====================
logs:
	@docker-compose logs -f

logs-backend:
	@docker-compose logs -f backend

logs-frontend:
	@docker-compose logs -f web-admin h5-mobile

logs-mysql:
	@docker-compose logs -f mysql

# ==================== è¿ç»´ç®¡ç† ====================
status:
	@echo "========================================"
	@echo "æœåŠ¡å¥åº·çŠ¶æ€æ£€æŸ¥"
	@echo "========================================"
	@docker-compose ps
	@echo ""
	@echo "å®¹å™¨èµ„æºä½¿ç”¨ï¼š"
	@docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" $$(docker-compose ps -q)

backup:
	@echo "í ½í²¾ å¤‡ä»½æ•°æ®åº“..."
	@mkdir -p backups
	@docker-compose exec -T mysql mysqldump -uroot -p$${MYSQL_ROOT_PASSWORD} $${MYSQL_DATABASE} > backups/backup_$$(date +%Y%m%d_%H%M%S).sql
	@echo "âœ… å¤‡ä»½å®Œæˆï¼æ–‡ä»¶ä¿å­˜åœ¨ backups/ ç›®å½•"

clean:
	@echo "í ½í·‘ï¸  æ¸…ç†æ‰€æœ‰å®¹å™¨ã€é•œåƒå’Œæ•°æ®å·..."
	@read -p "ç¡®è®¤è¦æ¸…ç†å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼(yes/no): " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		docker-compose down --rmi all --volumes --remove-orphans; \
		echo "âœ… æ¸…ç†å®Œæˆï¼"; \
	else \
		echo "âŒ å–æ¶ˆæ¸…ç†"; \
	fi
